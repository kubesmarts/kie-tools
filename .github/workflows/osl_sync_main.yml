name: "CI :: OSL :: Sync Main"

on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: sync-main
  cancel-in-progress: true

jobs:
  sync_main_apache:
    if: ${{ vars.ENABLE_OSL_SYNC_MAIN == 'yes' }}
    name: Sync main branch
    runs-on: ubuntu-latest

    steps:
      - name: Merge local branch with upstream/main (no commit)
        id: merge_upstream_main
        # TODO: change this
        uses: fantonangeli/kie-ci/.ci/actions/main-sync/merge@SRVLOGIC-633-Fix-token-issues-and-redesign-of-upstream-sync-CI
        with:
          main_sync_workflow_exclude_paths: ${{ vars.MAIN_SYNC_WORKFLOW_EXCLUDE_PATHS }}
          upstream_remote: ${{ vars.UPSTREAM_URL }}
          github_token: ${{ secrets.KIE1_TOKEN }}

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: "Bootstrap"
        env:
          MAVEN_ARGS: "-B -Puse-maven-repo-local-tail"
          MAVEN_OPTS: "-Xmx3g"
        uses: ./.github/actions/bootstrap
        with:
          pnpm_filter_string: ""

      - name: Create a PR to sync main branch with upstream/main
        # TODO: change this
        uses: fantonangeli/kie-ci/.ci/actions/main-sync/create-pr@SRVLOGIC-633-Fix-token-issues-and-redesign-of-upstream-sync-CI
        with:
          main_sync_workflow_pr_reviewers: ${{ vars.MAIN_SYNC_WORKFLOW_PR_REVIEWERS }}
          # TODO: change this
          dry_run: true
          sync_branch: ${{ steps.merge_upstream_main.outputs.sync_branch }}
          github_token: ${{ secrets.KIE1_TOKEN }}
